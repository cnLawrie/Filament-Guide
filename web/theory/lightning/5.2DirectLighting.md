# 直接照明

选择了物理学光单位意味着我们在shader计算出来的是流明单位的值，因此我们所有的估算光的函数都将计算给定节点的亮度L<sub>out</sub>（或出射辐射）。亮度结果基于光照度E和BSDF f(v,l)
L<sub>out</sub> = f(v,l)E

## 定向光
定向光的主要用途是在户外环境创建重要的光源（如太阳和月亮）。虽然现实世界中并不存在定向光，但是我们可以假设如果光源很远的话，那么它发出的光是定向的（即所有入射光线都是平行的，如图所示）

![diagram_directional_light](../../assets/lightning/5.2/diagram_directional_light.png)

这个假设对于表面的漫反射是没有问题的，但是对于镜面反射是错误的。寒霜引擎通过把太阳的定向光看做盘状的区域光来解决这个问题。

我们之前选择光照度(lx)作为定向光的单位，部分原因是因为我们可以很容易获得天空和太阳的光照度(从网上找或者自己用仪器测量），还可以简化上一节提到的亮度方程，如下：  

L<sub>out</sub> = f(v,l)E⊥ <n⋅l>

上式中，E⊥是垂直于光源的表面的光照度。例如，加入用定向光源模拟太阳，E⊥就是与太阳光方向垂直的表面的光照度。

下表提供了太阳和天空的光照度参考

![Table12](../../assets/lightning/5.2/Table12.png)

GLSL实现：
```
vec3 l = normalize(-lightDirection);
// dot是点乘函数，clamp是夹具函数，取三个数中的中间数
float NoL = clamp(dot(n, l), 0.0, 1.0);

// lightIntensity 垂直入射时的照明度
float illuminance = lightIntensity * NoL;
vec3 luminance = BSDF(v, l) * illuminance;
```

下图展示了模拟正午（照明度设为110,000lx)时，定向光照射一个简单场景的效果。

![screenshot_directional_light](../../assets/lightning/5.2/screenshot_directional_light.png)
图：定向光下的一排排不同粗糙度的电介质材质模型

## 精确光源

我们的引擎支持两类精确光源：点光源和聚光灯。这类光源通常在物理上来说并不精确，原因有两个
1. 他们在理论上是无穷小的
2. 他们并不遵循平方反比定律（平方反比定律又称为照度第一定律。它是一个关于光源照度与被照射物体之间距离关系的定律：在点光源的垂直照射下，被照射物体表面的光照度，与光源的发光强度成正比，与光源至被照射物体的表面距离的平方成反比）

第一个问题可以用区域光来处理，但是，鉴于精确光源的开销较低，应该尽可能使用无限小的精确光源。
第二个问题很容易解决，我们去遵循平方反比定律。 
L<sub>out</sub> = f(v,l)E中的E由下式计算得出，其中d是光源至被照射物体的表面距离。  

![57](../../assets/lightning/5.2/57.png)


点光源与聚光灯的不同就在于E是如何计算出来的，特别是光强I是怎么由光通量Φ计算得来。

### 点光源

一个点光源仅由空间中的位置定义，如下图  
![diagram_point_light](../../assets/lightning/5.2/diagram_point_light.png)

点光源的光通量通过在光的立体角上对光强积分得来。由下式，光强可以很容易由光通量推算出来。

![58](../../assets/lightning/5.2/58.png)

Lout=f(v,l)E与57、58联立可得下式：

![59](../../assets/lightning/5.2/59.png)

由上式，亮度可由光通量计算得出。

下图展示了点光源下的简单场景。为了凸显平方反比定律，加强了被照射物体表面的光照度受距离衰减的影响。

### 聚光灯

一个聚光灯由空间中的位置，一个方向矢量和两个(θ<sub>inner</sub> and θ<sub>outer</sub>)所定义。这两个锥角用于定义聚光灯的角度衰减。这个聚光灯模拟函数必须考虑平方反比函数，同时这两个角来模拟亮度的衰减。

![diagram_spot_light](../../assets/lightning/5.2/diagram_spot_light.png)

同理，聚光灯的光通量也可以由光强计算得来，如下式。与点光源中不同的是使用了外锥角作为积分上限，外围锥角大小范围在[0...π]。

![60](../../assets/lightning/5.2/60.png)

上式在物理学上来说是正确的，另一方面这导致聚光灯有些难用：改变外锥角的大小，会改变光照度级别。观察一下下图，外锥角的减小伴随着光照度级别的提升。

![screenshot_spot_light_focused](../../assets/lightning/5.2/screenshot_spot_light_focused.png)
外锥角55°(左)和15°（右）

光照度与外锥角的相互影响意味着美术人员在调节聚光灯的外锥角的同时，也会影响到光照度。给美术人员提供一个可以防止这种相互影响的参数十分有必要。

下式用另一种方式用光强计算光通量，其中没有外锥角，自然不会受其影响。

![61](../../assets/lightning/5.2/61.png)

下图中的测试场景使用了新的公式，果然在锥角不同的情况下，光照度等级一样。

![screenshot_spot_light](../../assets/lightning/5.2/screenshot_spot_light.png)
外锥角55°(左)和15°（右）

如果被照射物体表面是磨砂等吸光性能良好的表面，那么上式可以被视为物理上正确的。

故聚光灯模拟函数可以用两种方式表示：

- 对于光的吸收者：

![62](../../assets/lightning/5.2/62.png)

- 对于光的反射者：

![63](../../assets/lightning/5.2/63.png)

### 衰减函数


